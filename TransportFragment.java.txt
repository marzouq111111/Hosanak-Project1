/*
 * ÙˆØ­Ø¯Ø© Ø§Ù„Ù†Ù‚Ù„ - TransportFragment.java
 * ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰: Ø­Ø¬Ø² Ø§Ù„Ù†Ù‚Ù„ØŒ Ø§Ù„Ø®Ø±ÙŠØ·Ø©ØŒ ØªØªØ¨Ø¹ GPS
 */

package com.hosanak.app;

import android.os.Bundle;
import android.view.LayoutInflater;
import android.view.View;
import android.view.ViewGroup;
import android.widget.Button;
import android.widget.EditText;
import android.widget.TextView;
import android.widget.Toast;
import androidx.annotation.NonNull;
import androidx.annotation.Nullable;
import androidx.fragment.app.Fragment;
import com.google.firebase.firestore.FirebaseFirestore;
import java.util.*;

public class TransportFragment extends Fragment {
    
    // Ø¹Ù†Ø§ØµØ± Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
    private EditText etPickupLocation, etDropoffLocation, etHorseDetails;
    private Button btnBookTransport, btnTrackLocation;
    private TextView tvStatus;
    private FirebaseFirestore database;
    
    @Nullable
    @Override
    public View onCreateView(@NonNull LayoutInflater inflater, @Nullable ViewGroup container, 
                           @Nullable Bundle savedInstanceState) {
        View view = inflater.inflate(R.layout.fragment_transport, container, false);
        
        initViews(view);
        initFirebase();
        setupListeners();
        
        return view;
    }
    
    private void initViews(View view) {
        etPickupLocation = view.findViewById(R.id.et_pickup_location);
        etDropoffLocation = view.findViewById(R.id.et_dropoff_location);
        etHorseDetails = view.findViewById(R.id.et_horse_details);
        btnBookTransport = view.findViewById(R.id.btn_book_transport);
        btnTrackLocation = view.findViewById(R.id.btn_track_location);
        tvStatus = view.findViewById(R.id.tv_status);
    }
    
    private void initFirebase() {
        try {
            database = FirebaseFirestore.getInstance();
        } catch (Exception e) {
            Toast.makeText(getContext(), "Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª", Toast.LENGTH_SHORT).show();
        }
    }
    
    private void setupListeners() {
        btnBookTransport.setOnClickListener(v -> bookTransport());
        btnTrackLocation.setOnClickListener(v -> trackLocation());
    }
    
    // Ø¯Ø§Ù„Ø© Ø­Ø¬Ø² Ø§Ù„Ù†Ù‚Ù„
    private void bookTransport() {
        String pickup = etPickupLocation.getText().toString().trim();
        String dropoff = etDropoffLocation.getText().toString().trim();
        String horseDetails = etHorseDetails.getText().toString().trim();
        
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        if (pickup.isEmpty() || dropoff.isEmpty() || horseDetails.isEmpty()) {
            Toast.makeText(getContext(), "ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„", Toast.LENGTH_SHORT).show();
            return;
        }
        
        // Ø¥Ù†Ø´Ø§Ø¡ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø¬Ø²
        Map<String, Object> booking = new HashMap<>();
        booking.put("pickupLocation", pickup);
        booking.put("dropoffLocation", dropoff);
        booking.put("horseDetails", horseDetails);
        booking.put("bookingTime", new Date());
        booking.put("status", "pending");
        booking.put("customerPhone", "+965 XXXX XXXX");
        
        // Ø­ÙØ¸ ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        if (database != null) {
            database.collection("horseBookings")
                .add(booking)
                .addOnSuccessListener(documentReference -> {
                    tvStatus.setText("âœ… ØªÙ… Ø­Ø¬Ø² Ø§Ù„Ù†Ù‚Ù„ Ø¨Ù†Ø¬Ø§Ø­!");
                    clearForm();
                    Toast.makeText(getContext(), "ØªÙ… Ø§Ù„Ø­Ø¬Ø² Ø¨Ù†Ø¬Ø§Ø­!", Toast.LENGTH_LONG).show();
                })
                .addOnFailureListener(e -> {
                    Toast.makeText(getContext(), "ÙØ´Ù„ ÙÙŠ Ø§Ù„Ø­Ø¬Ø²: " + e.getMessage(), 
                                 Toast.LENGTH_SHORT).show();
                });
        }
    }
    
    // Ø¯Ø§Ù„Ø© ØªØªØ¨Ø¹ Ø§Ù„Ù…ÙˆÙ‚Ø¹
    private void trackLocation() {
        tvStatus.setText("ğŸ›°ï¸ Ø¬Ø§Ø±ÙŠ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹...");
        
        // Ù…Ø­Ø§ÙƒØ§Ø© ØªØªØ¨Ø¹ GPS
        new Thread(() -> {
            try {
                Thread.sleep(2000); // Ø§Ù†ØªØ¸Ø§Ø± Ø«Ø§Ù†ÙŠØªÙŠÙ†
                
                getActivity().runOnUiThread(() -> {
                    tvStatus.setText("ğŸ“ Ø§Ù„Ù…ÙˆÙ‚Ø¹: Ø§Ù„ÙƒÙˆÙŠØª Ø§Ù„Ø¹Ø§ØµÙ…Ø© - 29.3759Â°N, 47.9774Â°E");
                    Toast.makeText(getContext(), "ØªÙ… ØªØ­Ø¯ÙŠØ¯ Ù…ÙˆÙ‚Ø¹Ùƒ Ø¨Ù†Ø¬Ø§Ø­", Toast.LENGTH_SHORT).show();
                });
            } catch (InterruptedException e) {
                e.printStackTrace();
            }
        }).start();
    }
    
    // Ù…Ø³Ø­ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬
    private void clearForm() {
        etPickupLocation.setText("");
        etDropoffLocation.setText("");
        etHorseDetails.setText("");
    }
}

/*
 * Ù…Ù…ÙŠØ²Ø§Øª Ù‡Ø°Ù‡ Ø§Ù„ÙˆØ­Ø¯Ø©:
 * âœ… Ø­Ø¬Ø² Ù†Ù‚Ù„ Ø§Ù„Ø®ÙŠÙˆÙ„
 * âœ… ØªØªØ¨Ø¹ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø¨Ù€ GPS  
 * âœ… Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Firebase
 * âœ… Ø±Ø³Ø§Ø¦Ù„ ØªØ£ÙƒÙŠØ¯ Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…
 * âœ… ÙˆØ§Ø¬Ù‡Ø© Ø³Ù‡Ù„Ø© Ø§Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…
 */